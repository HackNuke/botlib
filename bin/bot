#!/usr/bin/env python3
# This file is placed in the Public Domain.

import os
import sys 

import bot.all

from cmn import spl
from dbs import last
from dpt import init, register
from hdl import Client, docmd, __version__
from obj import cfg, opts
from nms import Names, findnames
from prs import boot
from tbl import table
from trm import exec, termreset

mods = "adm,fnd,log,tdo,"

class CLI(Client):

    def handle(self, e):
        super().handle(e)
        e.wait()

    def raw(self, txt):
        print(txt)

class Console(CLI):

    def poll(self):
        return input("> ")

def daemon():
    pid = os.fork()
    if pid != 0:
        termreset()
        os._exit(0)
    os.setsid()
    os.umask(0)
    si = open("/dev/null", 'r')
    so = open("/dev/null", 'a+')
    se = open("/dev/null", 'a+')
    os.dup2(si.fileno(), sys.stdin.fileno())
    os.dup2(so.fileno(), sys.stdout.fileno())
    os.dup2(se.fileno(), sys.stderr.fileno())

def main():
    Names.tbl(table)
    boot()
    cfg.wd = cfg.wd or "/var/lib/bot/"
    cfg.name = "bot"
    cfg.version = __version__
    if cfg.txt:
        csl = CLI()
        register(mods+cfg.mods)
        return csl.cmd(cfg.otxt)
    if opts("d"):
        daemon()
    if opts("s"):
        csl = Client()
        register(mods+cfg.mods)
        csl.start()
        init(cfg.mods)
        csl.wait()
    if cfg.mods:
        csl = Console()
        register(mods+cfg.mods)
        csl.start()
        init(cfg.mods)
        csl.wait()

exec(main)
