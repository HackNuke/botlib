#!/usr/bin/env python3
# This file is placed in the Public Domain.

import os
import sys 

sys.path.insert(0, "bot")

from cmn import spl
from dbs import last
from hdl import Client, docmd, __version__
from krn import Kernel
from obj import cfg, opts
from nms import Names, findnames
from prs import boot
from trm import exec, termreset

mods = "adm,fnd,log,tdo,irc,rss,slg,udp"

class CLI(Client):

    def handle(self, e):
        super().handle(e)
        e.wait()

    def raw(self, txt):
        print(txt)

class Console(CLI):

    def poll(self):
        return input("> ")

def daemon():
    pid = os.fork()
    if pid != 0:
        termreset()
        os._exit(0)
    os.setsid()
    os.umask(0)
    si = open("/dev/null", 'r')
    so = open("/dev/null", 'a+')
    se = open("/dev/null", 'a+')
    os.dup2(si.fileno(), sys.stdin.fileno())
    os.dup2(so.fileno(), sys.stdout.fileno())
    os.dup2(se.fileno(), sys.stderr.fileno())

def main():
    k = Kernel()
    k.boot()
    cfg.wd = cfg.wd or "/var/lib/bot/"
    cfg.name = "bot"
    cfg.version = __version__
    k.regs(cfg.mods or mods)
    if cfg.txt:
        c = CLI()
        return c.cmd(cfg.otxt)
    if opts("d"):
        daemon()
    if cfg.mods:
        k.inits(cfg.mods)
    if opts("s"):
        c = Client()
        c.start()
    if opts("c"):
        c = Console()
        c.start()
    if opts("wcs"):
        c.wait()

exec(main)
