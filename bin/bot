#!/usr/bin/env python3
# This file is placed in the Public Domain.


"bot client"


import inspect
import os
import readline
import sys
import termios
import time
import traceback


from o.bus import Bus
from o.cls import Cls
from o.clt import Client
from o.cmd import Cmd
from o.cfg import Cfg
from o.dft import Default
from o.evt import Event
from o.krn import boot, kcmd, root
from o.prs import parse
from o.hdl import Handler
from o.tbl import Tbl
from o.tms import tfmt
from o.thr import launch


from o import Object, update, values


Cfg.wd = os.path.expanduser("~/.bot")


from bot.irc import IRC
from bot.rss import Fetcher


class Console(Client, Handler):


    def __init__(self):
        Client.__init__(self)
        Handler.__init__(self)
        Bus.add(self)

    def poll(self):
        e = Event()
        e.orig = repr(self)
        e.txt = input("> ")
        return e

    def raw(self, txt):
        print(txt)
 

def scan():
    for mod in values(Tbl.mod):
        for k, o in inspect.getmembers(mod, inspect.isfunction):
            if "event" in o.__code__.co_varnames:
                Cmd.cmds[k] = o
        for k, clz in inspect.getmembers(mod, inspect.isclass):
            Cls.add(clz)
        Tbl.add(mod)


def wrap(func):
    fd = sys.stdin.fileno()
    old = termios.tcgetattr(fd)
    try:
        func()
    except PermissionError:
        print("you need root privileges")
    except (EOFError, KeyboardInterrupt):
        print("")
    finally:
        termios.tcsetattr(fd, termios.TCSADRAIN, old)


import o.all
import bot.all


def main():
    print("BOT shell start at %s" % time.ctime(time.time()).replace("  ", " "))
    boot(" ".join(sys.argv[1:]))
    scan()
    c = Console()
    i = IRC()
    i.start()
    f = Fetcher()
    f.start()
    c.start()
    c.wait()


wrap(main)
