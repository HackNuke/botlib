#!/usr/bin/env python3
# This file is placed in the Public Domain.


"bot client"


import inspect
import os
import readline
import sys
import termios
import time
import traceback


from ob.bus import Bus
from ob.cls import Cls
from ob.clt import Client
from ob.cmd import Cmd
from ob.dft import Default
from ob.evt import Event
from ob.krn import Cfg, boot, kcmd, root
from ob.prs import parse
from ob.hdl import Handler
from ob.tbl import Tbl
from ob.tms import tfmt
from ob.thr import launch


from ob import Object, update, values


Cfg.wd = os.path.expanduser("~/.bot")


from bot.irc import IRC
from bot.rss import Fetcher


import ob.all
import bot.all


class Console(Client, Handler):


    def __init__(self):
        Client.__init__(self)
        Handler.__init__(self)
        Bus.add(self)

    def poll(self):
        e = Event()
        e.orig = repr(self)
        e.txt = input("> ")
        return e

    def raw(self, txt):
        print(txt)
 

def scan():
    for mod in values(Tbl.mod):
        for k, o in inspect.getmembers(mod, inspect.isfunction):
            if "event" in o.__code__.co_varnames:
                Cmd.cmds[k] = o
        for k, clz in inspect.getmembers(mod, inspect.isclass):
            Cls.add(clz)
        Tbl.add(mod)


def wrap(func):
    fd = sys.stdin.fileno()
    old = termios.tcgetattr(fd)
    try:
        func()
    except PermissionError:
        print("you need root privileges")
    except (EOFError, KeyboardInterrupt):
        print("")
    finally:
        termios.tcsetattr(fd, termios.TCSADRAIN, old)


def main():
    print("BOT shell start at %s" % time.ctime(time.time()).replace("  ", " "))
    boot(" ".join(sys.argv[1:]))
    scan()
    c = Console()
    i = IRC()
    i.start()
    f = Fetcher()
    f.start()
    c.start()
    c.wait()


wrap(main)
