#!/usr/bin/env python3
# This file is placed in the Public Domain.

__version__ = 120

import importlib
import bot
import os
import sys 

sys.path.insert(0, "bot")

from cmn import spl
from hdl import Client, docmd, init
from obj import cfg, boot, opts
from nms import Names, findnames
from prs import parseargs
from trm import exec, termreset

mods = "adm,fnd,irc,log,rss,tdo,udp"

class CLI(Client):

    def handle(self, e):
        super().handle(e)
        e.wait()

    def raw(self, txt):
        print(txt)

class Console(CLI):

    def poll(self):
        return input("> ")

def daemon():
    pid = os.fork()
    if pid != 0:
        termreset()
        os._exit(0)
    os.setsid()
    os.umask(0)
    si = open("/dev/null", 'r')
    so = open("/dev/null", 'a+')
    se = open("/dev/null", 'a+')
    os.dup2(si.fileno(), sys.stdin.fileno())
    os.dup2(so.fileno(), sys.stdout.fileno())
    os.dup2(se.fileno(), sys.stderr.fileno())

def main():
    boot()
    cfg.name = "bot"
    cfg.version = __version__
    cfg.wd = cfg.wd or "/var/lib/bot/"
    if opts("d"):
        daemon()
        csl = CLI()
    else:
        csl = Console()
    csl.reg(cfg.mods or mods)
    if cfg.txt:
        return csl.cmd(cfg.otxt)
    csl.start()
    init(cfg.mods)
    csl.wait()

exec(main)
