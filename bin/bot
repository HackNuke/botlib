#!/usr/bin/env python3
# This file is placed in the Public Domain.

import os
import readline
import sys
import termios
import time

wd = os.path.expanduser("~/.bot")


from bot.obj import fmt, keys, spl
from bot.run import Client, Runtime
from bot.tbl import Table
from bot.trc import get_exception

class Kernel(Runtime):

    def error(self, txt):
        print(txt)
        sys.stdout.flush()
        
    def log(self, txt):
        if "PING" in txt or "PONG" in txt:
            return
        if k.cfg.verbose:
            print(txt)
            sys.stdout.flush()


class CLI(Client):

    def handle(self, clt, e):
        k.put(e)

    def raw(self, txt):
        pass

class Console(Client):

    def handle(self, clt, e):
        k.put(e)
        e.wait()

    def poll(self):
        return input("> ")

    def raw(self, txt):
        print(txt)
        sys.stdout.flush()


clt = Console()
k = Kernel()
tbl = Table()

import bot.all


def wrap(func):
    import termios
    fd = sys.stdin.fileno()
    old = termios.tcgetattr(fd)
    try:
        func()
    except KeyboardInterrupt:
        pass
    except PermissionError as ex:
        print(str(ex))
    except Exception as ex:
        print(get_exception())
    finally:
        termios.tcsetattr(fd, termios.TCSADRAIN, old)


def main(): 
    k.boot()
    tbl.scan("bot")
    if k.cfg.verbose:
        k.log("BOT started at %s" % time.ctime(time.time()))
        k.log(",".join(sorted(keys(tbl.modnames))))
    if k.opt("b"):
        k.cfg.bork = True
    if k.cfg.txt:
        return k.cmd(k.cfg.txt)
    if k.cfg.verbose:
        k.log("tbl %s nms %s" % (len(tbl.modnames), len(tbl.names)))
        k.log(fmt(k.cfg, skip=["password"]))
    do = k.cfg.mod
    if k.opt("cw") or do:
        k.start()
        for mn in spl(k.cfg.mod):
            k.init("bot.%s" % mn)
    if k.opt("c") or do:
        clt.start()
    if k.opt("cw") or do:
        k.log("using %s" % wd)
        k.wait()

wrap(main)
