#!/usr/bin/env python3
# This file is placed in the Public Domain.

"""


import os
import sys
import termios
import time

wd = os.path.expanduser("~/.bot")

from bot.obj import keys, spl
from bot.run import Client, Runtime
from bot.tbl import Table
from bot.trc import get_exception


class Kernel(Runtime):

    def error(self, txt):
        print(txt)
        sys.stdout.flush()
        
    def log(self, txt):
        if "PING" in txt or "PONG" in txt:
            return
        print(txt)
        sys.stdout.flush()


class CLI(Client):

    def handle(self, clt, e):
        k.put(e)

    def raw(self, txt):
        print(txt)
        sys.stdout.flush()

class Console(Client):

    def handle(self, clt, e):
        k.put(e)
        e.wait()

    def poll(self):
        return input("> ")

    def raw(self, txt):
        print(txt)
        sys.stdout.flush()


clt = Console()
k = Kernel()
t = Table()


import bot.all


def daemon():
    pid = os.fork()
    if pid != 0:
        os._exit(0)
    os.setsid()
    os.umask(0)
    si = open("/dev/null", "r")
    so = open("/dev/null", "a+")
    se = open("/dev/null", "a+")
    os.dup2(si.fileno(), sys.stdin.fileno())
    os.dup2(so.fileno(), sys.stdout.fileno())
    os.dup2(se.fileno(), sys.stderr.fileno())


def wrap(func):
    fd = sys.stdin.fileno()
    old = termios.tcgetattr(fd)
    try:
        func()
    except KeyboardInterrupt:
        pass
    except PermissionError as ex:
        print(str(ex))
    except Exception as ex:
        print(get_exception())
    finally:
        termios.tcsetattr(fd, termios.TCSADRAIN, old)

def initialize(mods):
    m = ""
    for mn in spl(mods):
        m += ",bot.%s" % mn
    k.init(m)

def main(): 
    k.boot()
    wait = False
    t.scan("bot")
    if k.cfg.txt:
        return k.cmd(k.cfg.txt)
    if k.cfg.verbose:
        k.log("BOT started at %s" % time.ctime(time.time()))
        k.log(k.cfg)
        k.log(",".join(sorted(keys(t.modnames))))
    if k.opt("d"):
        daemon()
    if k.opts("dc"):
        k.start()
        initialize(k.cfg.m)
        wait = True
    if k.opt("c") or k.cfg.m:
        clt.start()
        wait = True
    if k.opt("b"):
        k.cfg.bork = True
    if k.opt("w") or wait:
        k.wait()


wrap(main)
% BOT(1) BOT(1)
% Bart Thate
% Aug 2021

# NAME
BOT - python3 irc bot

# SYNOPSIS
| bot \<cmd>\ 
| bot cfg server=irc.freenode.net channel=\\#bot
| bot m=irc,rss

# DESCRIPTION
BOT an attempt to achieve OS level integration of bot technology directly
into the operating system. A solid, non hackable bot version, that can offer
"display in your irc channel" functionality to the unix programmer. BOT
runs on both BSD and Linux, is placed in the Public Domain, and, one day,
will be the thing you cannot do without ;]

# EXAMPLES

| $ bot
| $ 

| $ bot cmd
| cfg,cmd,dlt,ech,exc,flt,fnd,krn,met,sve,thr,upt,ver

| $ bot cfg
| cc=@ channel=#botd nick=botd port=6667 server=localhost

| bot krn
| $ cmd=krn name=bot txt=krn users=True version=1 wd=/home/bart/.bot

| $ bot thr
| CLI.handler 0s | CLI.input 0s

| $ bot m=bot.irc,bot.rss
| >

# SEE ALSO
| botd
| botctl
| ~/.bot
| ./mod

# COPYRIGHT
BOT is placed in the Public Domain, no COPYRIGHT, no LICENSE.
