#!/usr/bin/env python3
# This file is placed in the Public Domain.


import doctest
import inspect
import os
import sys
import unittest


sys.path.insert(0, os.getcwd())


from ob.cfg import Cfg
from ob.cls import Cls
from ob.cmd import Cmd
from ob.tbl import Tbl
from ob.prs import parse

from ob import Object, values


flags = doctest.REPORT_NDIFF | doctest.FAIL_FAST | doctest.ELLIPSIS


Cfg.wd = ".test"


def scan():
    for mod in values(Tbl.mod):
        for k, o in inspect.getmembers(mod, inspect.isfunction):
            if "event" in o.__code__.co_varnames:
                Cmd.cmds[k] = o
        for k, clz in inspect.getmembers(mod, inspect.isclass):
            Cls.add(clz)
        Tbl.add(mod)

import ob.all
import bot.all


def main():
    scan()
    p = Object()
    parse(p, " ".join(sys.argv[1:]))
    Cfg.verbose = "v" in p.opts
    pat = "test_%s*" % "*"
    suite = unittest.loader.TestLoader().discover("test", pattern=pat)
    unittest.TextTestRunner(verbosity=3).run(suite)


main()
