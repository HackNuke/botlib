#!/usr/bin/env python3
# This file is placed in the Public Domain.

"python3 object library"

__version__ = 124

import os, sys

sys.path.insert(0, os.getcwd())

import atexit
import doctest
import os
import readline
import shutil
import sys
import termios
import unittest

wd = ".test"

from bot.krn import Kernel, Test
from bot.hdl import Handler
from trm import cprint, wrap

flags = doctest.REPORT_NDIFF | doctest.FAIL_FAST | doctest.ELLIPSIS

class Runtime(Kernel):

    def error(self, txt):
        cprint(txt)


class MyTest(Test):

    def raw(self, txt):
        if k.opts("v"):
            cprint(txt)

k = Runtime()

def ver(event):
    event.reply("BOTLIB %s" % __version__)


def main():
    if os.path.exists(".test"):
        shutil.rmtree(".test")
    k.boot()
    k.add(ver)
    k.scan("bot")
    k.cfg.verbose = k.opts("v")
    for cls in k.classes.values():
        c = cls()
        c.txt = "bla"
        c.save()
    k.start()
    c = MyTest()
    c.start()
    pat = "test_%s*" % "*"
    suite = unittest.loader.TestLoader().discover("test", pattern=pat)
    unittest.TextTestRunner(verbosity=3).run(suite)
    doctest.testfile(
        "../test/test1.txt", optionflags=flags, globs=globals(),report=False, verbose=False
    )
    doctest.testfile(
        "../test/test2.txt", optionflags=flags, globs=globals(), report=False, verbose=False
    )


wrap(main)
