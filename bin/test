#!/usr/bin/env python3
# This file is placed in the Public Domain.


"test"


import doctest
import inspect
import os
import shutil
import sys
import unittest


from op.cls import Cls
from op.cmd import Cmd
from op.krn import Cfg, boot
from op.obj import Object, values
from op.prs import parse
from op.tbl import Tbl


flags = doctest.REPORT_NDIFF | doctest.FAIL_FAST | doctest.ELLIPSIS


Cfg.wd = ".test"


def scan():
    for mod in values(Tbl.mod):
        for k, o in inspect.getmembers(mod, inspect.isfunction):
            if "event" in o.__code__.co_varnames:
                Cmd.cmds[k] = o
        for k, clz in inspect.getmembers(mod, inspect.isclass):
            Cls.add(clz)
        Tbl.add(mod)


import op.all
import bot.all


def main():
    if os.path.exists(Cfg.wd):
        shutil.rmtree(Cfg.wd)
    boot(" ".join(sys.argv[1:]))
    Cfg.debug = True
    scan()
    pat = "test_%s*" % "*"
    suite = unittest.loader.TestLoader().discover("test", pattern=pat)
    unittest.TextTestRunner(verbosity=3).run(suite)


main()
