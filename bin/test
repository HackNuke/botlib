#!/usr/bin/python3
#
# run unittests.

__version__ = 1

import os,sys ; sys.path.insert(0, os.getcwd())

import bot
import bot.lib
import logging
import os
import shutil
import time
import unittest

from bot.lib import cdir, cfg, starttime
from bot.lib.krn import Kernel
from bot.lib.shl import execute, level, parse_cli 
from bot.lib.tms import elapsed

opts = [
    ('-b', '--bork', 'store_true', False, 'bork on exception.', 'bork'),
    ('-v', '--verbose', 'store_true', False, 'enable verbose mode.', 'verbose'),
    ('-m', '--modules', 'store', str, "bot.mods", 'modules to load.', 'modules'),
    ('-o', '--options', 'store', str, "", 'options to use.', 'options'),
    ('-w', '--workdir', 'store', str, ".data", 'set working directory.', 'workdir'),
    ('-l', '--loglevel', 'store', str, "error", 'set loglevel.', 'level'),
]

resume = {}

def main():
    try:
        shutil.rmtree(".data")
    except FileNotFoundError:
        pass
    cdir(".data")
    parse_cli("test", opts)
    bot.lib.cfg.debug = True
    k = Kernel()
    k.fleet.add(k)
    mods = k.walk(cfg.modules)
    k.scan(mods)
    k.start(False,False)
    test_path = os.getcwd() + os.sep + "tests"
    suite = unittest.loader.TestLoader().discover(test_path, pattern="test*")
    unittest.TextTestRunner(verbosity=3).run(suite)
    k.wait()
   
execute(main)
print(elapsed(time.time() - starttime))
os._exit(0)
