#!/usr/bin/env python3
# This file is placed in the Public Domain.


"bot shell"


import inspect
import os
import readline
import sys
import termios
import time
import traceback


sys.path.insert(0, os.getcwd())


from ot.cls import Cls
from ot.cmd import Cmd
from ot.obj import Object, values
from ot.dbs import Cfg
from ot.evt import Event
from ot.obj import update
from ot.krn import boot
from ot.fnc import format
from ot.prs import parse
from ot.hdl import Handler
from ot.tbl import Tbl
from ot.tms import tfmt
from ot.thr import launch


import bot.all


Cfg.wd = os.path.expanduser("~/.bot")


class Console(Handler):


    def poll(self):
        e = Event()
        e.orig = repr(self)
        e.txt = input("> ")
        return e
 
    def raw(self, txt):
        print(txt)


def scan():
    for mod in values(Tbl.mod):
        for k, o in inspect.getmembers(mod, inspect.isfunction):
            if "event" in o.__code__.co_varnames:
                Cmd.cmds[k] = o
        for k, clz in inspect.getmembers(mod, inspect.isclass):
            Cls.add(clz)
        Tbl.add(mod)


def wrap(func):
    fd = sys.stdin.fileno()
    old = termios.tcgetattr(fd)
    try:
        func()
    except (EOFError, KeyboardInterrupt):
        print("")
    finally:
        termios.tcsetattr(fd, termios.TCSADRAIN, old)


def main():
    scan()
    c = Console()
    c.start()
    c.wait()


wrap(main)
