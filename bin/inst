#!/usr/bin/python3

import os

servicetxt="""[Unit]
Description=OBOT - 24/7 channel daemon
After=network-online.target

[Service]
DynamicUser=True
StateDirectory=obot
LogsDirectory=obot
CacheDirectory=obot
StandardOutput=append:/var/log/obot/obot.log
ExecStart=/usr/local/bin/obotd wd=/var/lib/obot mods=irc,rss,udp -w
CapabilityBoundingSet=CAP_NET_RAW

[Install]
WantedBy=multi-user.target
"""

def ignore(txt, skip=["already"]):
    txt += " 2>&1"
    try:
        for line in os.popen(txt).readlines():
             pass
    except Exception as ex:
        for rej in skip:
           if rej in str(ex):
               return

def run(txt, skip=["already"]):
    try:
        for line in os.popen(txt).readlines():
             print(line.rstrip())
    except Exception as ex:
        for rej in skip:
           if rej in str(ex):
               return

def postinstall():
    writeservice()
    run("cp bin/obotd /usr/local/obotd")
    #open("chown obot:obot /usr/local/bin/obotd")
    run("systemctl enable obot")
    run("systemctl daemon-reload")
    run("service obot restart")
    run("systemctl status obot")

def writeservice():
    p = "/etc/systemd/system/obot.service"
    f = open(p, "w")
    f.write(servicetxt)
    f.close()

def mods():
    import os
    return [x[:-3] for x in os.listdir("lib") if x.endswith(".py")]

def read():
    return open("README.rst", "r").read()

postinstall()
