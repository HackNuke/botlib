#!/usr/bin/env python3
# This file is placed in the Public Domain.


import os
import random
import shutil
import sys
import termios
import time


sys.path.insert(0, os.getcwd())


from bot.clt import Client
from bot.krn import k
from bot.obj import Cfg, Object, cdir
from bot.ofn import fmt, indexed
from bot.tbl import Table
from bot.thr import launch, multi
from bot.tms import elapsed
from bot.utl import consume


from run import skel, wrap


Cfg.wd = ".test"


param = Object()
param.add = ["test@shell", "bart", ""]
param.cfg = ["server=localhost", ""]
param.dne = ["test4", ""]
param.rem = ["reddit", ""]
param.dpl = ["reddit title,summary,link", ""]
param.log = ["test1", ""]
param.flt = ["0", ""]
param.fnd = ["cfg", "log", "rss", "log txt==test", "cfg server==localhost", "rss rss==reddit"]
param.rss = ["https://www.reddit.com/r/python/.rss"]
param.tdo = ["test4", ""]


class CLI(Client):

    def raw(self, txt):
        print(txt)


clt = CLI()
events = []


def payload():
    c = k.first()
    cmds = list(Table.modnames)
    random.shuffle(cmds)
    for cmd in cmds:
        for ex in getattr(param, cmd, [""]):
            e = c.event(cmd + " " + ex)
            k.dispatch(e)
            events.append(e)


import bot.all


def main():
    skel(Cfg.wd)
    k.parse_cli(" ".join(sys.argv[1:]))
    k.scan("bot")
    k.cfg.debug = True
    k.start()
    clt.start()
    nr = k.cfg.index or 1
    t = time.time()
    for thr in multi(nr, payload):
        thr.join()
    consume(events)
    print(elapsed(time.time()-t))

wrap(main)
