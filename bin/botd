#!/usr/bin/env python3
# This file is placed in the Public Domain.

import os
import sys 

from botd.hdl import Client, docmd, init, __version__
from botd.obj import cfg, opts
from botd.nms import Names, findnames
from botd.prs import parse_cli
from botd.tbl import table
from botd.utl.cmn import spl
from botd.utl.trm import exec, termreset

mods = "adm,fnd,irc,log,rss,tdo,udp"

class CLI(Client):

    def handle(self, e):
        super().handle(e)
        e.wait()

    def raw(self, txt):
        print(txt)

class Console(CLI):

    def poll(self):
        return input("> ")

def daemon():
    pid = os.fork()
    if pid != 0:
        termreset()
        os._exit(0)
    os.setsid()
    os.umask(0)
    si = open("/dev/null", 'r')
    so = open("/dev/null", 'a+')
    se = open("/dev/null", 'a+')
    os.dup2(si.fileno(), sys.stdin.fileno())
    os.dup2(so.fileno(), sys.stdout.fileno())
    os.dup2(se.fileno(), sys.stderr.fileno())

def main():
    Names.tbl(table)
    parse_cli()
    cfg.name = "botd"
    cfg.version = __version__
    cfg.wd = cfg.wd or "/var/lib/botd/"
    if opts("d"):
        daemon()
        cfg.mods += ",irc"
    if opts("c"):
        csl = Console()
    else:
        csl = Client()
    if cfg.txt:
        csl = CLI()
        csl.reg(mods)
        return csl.cmd(cfg.otxt)
    csl.reg(cfg.mods or mods)
    csl.start()
    init(cfg.mods)
    csl.wait()

exec(main)
