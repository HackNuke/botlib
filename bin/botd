#!/usr/bin/env python3
# This file is placed in the Public Domain.


"24/7 channel daemon"


import inspect
import os
import sys
import termios
import time
import traceback


from op.bus import Bus
from op.cls import Cls
from op.cmd import Cmd
from op.dbs import Cfg
from op.evt import Event
from op.obj import Object, update
from op.prs import parse
from op.hdl import Handler
from op.tms import tfmt
from op.thr import launch


import bot.all


from bot.irc import IRC
from bot.rss import Fetcher


Cfg.wd = os.path.expanduser("~/.bot")


def daemon():
    print("BOT daemon start at %s" % time.ctime(time.time()).replace("  ", " "))
    pid = os.fork()
    if pid != 0:
        os._exit(0)
    os.setsid()
    os.umask(0)
    si = open("/dev/null", 'r')
    so = open("/dev/null", 'a+')
    se = open("/dev/null", 'a+')
    os.dup2(si.fileno(), sys.stdin.fileno())
    os.dup2(so.fileno(), sys.stdout.fileno())
    os.dup2(se.fileno(), sys.stderr.fileno())


def main():
    daemon()
    i = IRC()
    i.start()
    f = Fetcher()
    f.start()
    while 1:
        time.sleep(1.0)

main()
