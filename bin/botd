#!/usr/bin/env python3
# This file is placed in the Public Domain.


"bot client"


import inspect
import os
import readline
import sys
import termios
import time
import traceback


from ot.cls import Cls
from ot.cmd import Cmd
from ot.obj import Object, update, values
from ot.cfg import Cfg
from ot.dft import Default
from ot.evt import Event
from ot.krn import boot, kcmd, root
from ot.prs import parse
from ot.hdl import Handler
from ot.tbl import Tbl
from ot.tms import tfmt
from ot.thr import launch


Cfg.wd = os.path.expanduser("~/.bot")


import ot.all
import bot.all


from bot.irc import IRC
from bot.rss import Fetcher


class Console(Handler):


    def poll(self):
        e = Event()
        e.orig = repr(self)
        e.txt = input("> ")
        return e
 
    def raw(self, txt):
        print(txt)


def daemon():
    pid = os.fork()
    if pid != 0:
        os._exit(0)
    os.setsid()
    os.umask(0)
    si = open("/dev/null", 'r')
    so = open("/dev/null", 'a+')
    se = open("/dev/null", 'a+')
    os.dup2(si.fileno(), sys.stdin.fileno())
    os.dup2(so.fileno(), sys.stdout.fileno())
    os.dup2(se.fileno(), sys.stderr.fileno())


def scan():
    for mod in values(Tbl.mod):
        for k, o in inspect.getmembers(mod, inspect.isfunction):
            if "event" in o.__code__.co_varnames:
                Cmd.cmds[k] = o
        for k, clz in inspect.getmembers(mod, inspect.isclass):
            Cls.add(clz)
        Tbl.add(mod)


def wrap(func):
    fd = sys.stdin.fileno()
    old = termios.tcgetattr(fd)
    try:
        func()
    except PermissionError:
        print("you need root privileges")
    except (EOFError, KeyboardInterrupt):
        print("")
    finally:
        termios.tcsetattr(fd, termios.TCSADRAIN, old)


def main():
    print("BOT daemon start at %s" % time.ctime(time.time()).replace("  ", " "))
    daemon()
    scan()
    i = IRC()
    i.start()
    f = Fetcher()
    f.start()
    i.wait()

wrap(main)
