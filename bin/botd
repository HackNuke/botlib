#!/usr/bin/env python3
# This file is placed in the Public Domain.


"reverse bot daemon"


import inspect
import os
import sys
import termios
import time
import traceback


sys.path.insert(0, os.getcwd())


from ob.bus import Bus
from ob.cls import Cls
from ob.cmd import Cmd
from ob.dbs import Cfg
from ob.evt import Event
from ob.obj import Object, update, values
from ob.prs import parse
from ob.hdl import Handler
from ob.tms import tfmt
from ob.thr import launch
from ob.tbl import Tbl

import ob.all
import mod.all


from mod.irc import IRC
from mod.rss import Fetcher


Cfg.wd = os.path.expanduser("~/.ob")


def daemon():
    pid = os.fork()
    if pid != 0:
        os._exit(0)
    os.setsid()
    os.umask(0)
    si = open("/dev/null", 'r')
    so = open("/dev/null", 'a+')
    se = open("/dev/null", 'a+')
    os.dup2(si.fileno(), sys.stdin.fileno())
    os.dup2(so.fileno(), sys.stdout.fileno())
    os.dup2(se.fileno(), sys.stderr.fileno())


def scan():
    for mod in values(Tbl.mod):
        for k, o in inspect.getmembers(mod, inspect.isfunction):
            if "event" in o.__code__.co_varnames:
                Cmd.cmds[k] = o
        for k, clz in inspect.getmembers(mod, inspect.isclass):
            Cls.add(clz)
        Tbl.add(mod)


def main():
    scan()
    sys.stdout.flush()
    daemon()
    i = IRC()
    i.start()
    f = Fetcher()
    f.start()
    while 1:
        time.sleep(1.0)

main()
