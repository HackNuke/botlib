#!/usr/bin/env python3
# This file is placed in the Public Domain.


import os
import random
import shutil
import sys
import termios
import time


sys.path.insert(0, os.getcwd())


from bot.clt import Client
from bot.krn import k
from bot.obj import Cfg, Object, cdir, values
from bot.ofn import indexed
from bot.ofn import fmt
from bot.tbl import Table
from bot.thr import launch, multi
from bot.tms import elapsed
from bot.utl import consume


from run import skel, wrap


Cfg.wd = ".test"


param = Object()
param.add = ["test@shell", "bart", ""]
param.cfg = ["server=localhost", ""]
param.dne = ["test4", ""]
param.rem = ["reddit", ""]
param.dpl = ["reddit title,summary,link", ""]
param.log = ["test1", ""]
param.flt = ["0", ""]
param.fnd = ["cfg", "log", "rss", "log txt==test", "cfg server==localhost", "rss rss==reddit"]
param.rss = ["https://www.reddit.com/r/python/.rss"]
param.tdo = ["test4", ""]


class CLI(Client):

    def raw(self, txt):
        indexed(results, txt)


clt = CLI()
events = []


def payload():
    for mod in values(Table.modules):
        for on in dir(mod):
            o = getattr(mod, on, None)
            if o and "__code__" in dir(o):
                print(o.__code__.co_filename)
                #for nm in o.__code__.co_varnames:
                #    print(nm)
                for nm in o.__code__.co_names:
                    print(nm)


import bot.all


def main():
    t = time.time()
    skel(Cfg.wd)
    k.parse_cli(" ".join(sys.argv[1:]))
    k.cfg.debug = True
    k.scan()
    k.start()
    clt.start()
    for thr in multi(k.cfg.index or 1, payload):
        thr.join()
    consume(events)
    print(elapsed(time.time()-t))

wrap(main)
